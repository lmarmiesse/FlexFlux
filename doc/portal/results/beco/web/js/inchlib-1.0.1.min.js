var InCHlib;(function(e){InCHlib=function(t){this.user_settings=t;this.target_element=e("#"+t.target);var n=this.target_element.width();this.target_element.css({position:"relative"});this.settings={target:"YourOwnDivId",heatmap:true,heatmap_header:true,dendrogram:true,metadata:false,max_height:800,width:n,heatmap_colors:"Greens",heatmap_font_color:"black",heatmap_part_width:.7,column_dendrogram:false,independent_columns:true,metadata_colors:"Oranges",highlight_colors:"Reds",highlighted_rows:[],count_column:false,count_column_colors:"Reds",min_row_height:false,max_row_height:25,max_column_width:150,font:"Helvetica",values_center:"median",draw_row_ids:false,header_as_heatmap_row:false,header_row_colors:"YlOrB",show_export_button:true};this.events={row_onclick:function(e,t){return},row_onmouseover:function(e,t){return},row_onmouseout:function(e){return},dendrogram_node_onclick:function(e,t,n){return},dendrogram_node_highlight:function(e,t){return},dendrogram_node_unhighlight:function(e){return},heatmap_onmouseout:function(e){return},on_zoom:function(e){return},on_unzoom:function(e){return},on_refresh:function(){return},empty_space_onclick:function(e){return}};this.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}};this.objects_ref={tooltip_label:new Kinetic.Label({opacity:1,listening:false}),tooltip_tag:new Kinetic.Tag({fill:"#9E9E9E",pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:false}),tooltip_text:new Kinetic.Text({fontFamily:this.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:false,align:"center",lineHeight:1.2}),row_border:new Kinetic.Line({stroke:"black",strokeWidth:.5,lineCap:"round",shadowOffset:1,dash:[4,2],listening:false}),row_borders:new Kinetic.Group,row_node:new Kinetic.Line({stroke:"grey",strokeWidth:"2",lineCap:"sqare",lineJoin:"round",listening:false}),column_node:new Kinetic.Line({stroke:"grey",strokeWidth:"2",lineCap:"sqare",lineJoin:"round",listening:false}),row_node_rect:new Kinetic.Rect({fill:"white",opacity:0}),icon_overlay:new Kinetic.Rect({width:32,height:32,opacity:0}),heatmap_value:new Kinetic.Text({fontFamily:this.settings.font,fill:this.settings.heatmap_font_color,fontStyle:"bold",listening:false}),heatmap_line:new Kinetic.Line({lineCap:"butt",value:false}),column_header:new Kinetic.Text({fontFamily:this.settings.font,fontStyle:"bold",fill:"black"}),row_count:new Kinetic.Text({fontSize:14,fontFamily:this.settings.font,fontStyle:"bold",fill:"grey",listening:false}),cluster_border:new Kinetic.Line({stroke:"black",strokeWidth:2,lineJoin:"round",dash:[10,5],listening:false}),cluster_overlay:new Kinetic.Rect({fill:"white",opacity:.6}),icon:new Kinetic.Path({fill:"grey",scale:1}),rect_gradient:new Kinetic.Rect({x:0,y:80,width:120,height:20,fillLinearGradientStartPoint:{x:0,y:80},fillLinearGradientEndPoint:{x:100,y:80},stroke:"#D2D2D2",strokeWidth:"1px"})};e.extend(this.settings,t);this.settings.width=t.max_width&&t.max_width<n?t.max_width:this.settings.width;this.settings.heatmap_part_width=this.settings.heatmap_part_width>.9?.9:this.settings.heatmap_part_width;this.header_height=150;this.footer_height=70;this.dendrogram_heatmap_distance=5;this.heatmap_width=0;this.highlighted_row=null;this.leaves_y_coordinates={};this.rows={}};InCHlib.prototype.read_data=function(e){this.json=e;this.data=this.json.data;var t={};if(this.json["metadata"]!==undefined){this.metadata=this.json.metadata;t.metadata=true}else{t.metadata=false}if(this.json["column_dendrogram"]!==undefined){this.column_dendrogram=this.json.column_dendrogram;t.column_dendrogram=true}else{t.column_dendrogram=false}this._update_user_settings(t)};InCHlib.prototype.read_data_from_file=function(t){var n=this;e.ajax({type:"GET",url:t,dataType:"json",success:function(e){n.read_data(e)},async:false})};InCHlib.prototype._update_user_settings=function(t){var n={},r;for(var i=0,s=Object.keys(t),o=s.length;i<o;i++){r=s[i];if(this.user_settings[r]!==undefined&&this.user_settings[r]!==t[r]&&this.user_settings[r]===true){n[r]=false}else if(this.user_settings[r]===undefined){n[r]=t[r]}}e.extend(this.settings,n)};InCHlib.prototype._add_prefix=function(){var e,t;for(e in this.data.nodes){t=[this.settings.target,e].join("#");this.data.nodes[t]=this.data.nodes[e];delete this.data.nodes[e];if("parent"in this.data.nodes[t]){this.data.nodes[t].parent=[this.settings.target,this.data.nodes[t].parent].join("#")}if(this.data.nodes[t]["count"]!=1){this.data.nodes[t].left_child=[this.settings.target,this.data.nodes[t].left_child].join("#");this.data.nodes[t].right_child=[this.settings.target,this.data.nodes[t].right_child].join("#")}}if(this.settings.metadata){for(e in this.metadata.nodes){t=[this.settings.target,e].join("#");this.metadata.nodes[t]=this.metadata.nodes[e];delete this.metadata.nodes[e]}}return};InCHlib.prototype._get_root_id=function(e){var t,n;for(t in e){if(!("parent"in e[t])){n=t;break}}return n};InCHlib.prototype._get_dimensions=function(e){var t,n;for(n in e){if(e[n].count==1){t=e[n].features.length;break}else if(Object.prototype.toString.call(e[n])=="[object Array]"){t=e[n].length;break}}return t};InCHlib.prototype._get_min_max_middle=function(e){var t;var n=[];var r=[];for(t=0;t<e.length;t++){r=r.concat(e[t])}n.push(Math.min.apply(null,r));n.push(Math.max.apply(null,r));n.push(this._middle2fnc(r));return n};InCHlib.prototype._get_columns_min_max_middle=function(e){var t=this;var n=[];var r,i,s;var o=e[0].length;for(r=0;r<o;r++){n.push([])}for(r=0;r<e.length;r++){for(i=0;i<o;i++){s=e[r][i];if(typeof s!="undefined"){n[i].push(s)}}}var u=[],a,f,l;for(r=0;r<n.length;r++){if(this._is_number(n[r][0])){n[r]=n[r].map(parseFloat);a=Math.min.apply(null,n[r]);f=Math.max.apply(null,n[r]);l=this._middle2fnc(n[r])}else{var c=this._get_hash_object(n[r]);a=0;f=this._hack_size(c)-1;l=f/2;this.categories2numbers[r]=c}u.push([a,f,l])}return u};InCHlib.prototype._get_hash_object=function(e){var t,n=0,r={};for(t=0;t<e.length;t++){if(typeof r[e[t]]=="undefined"){r[e[t]]=n;n++}}return r};InCHlib.prototype._get_max_length=function(e){var t=e.map(function(e){return(""+e).length});var n=Math.max.apply(Math,t);return n};InCHlib.prototype._get_max_value_length=function(){var e=this.data.nodes;var t=0;var n,r,i;for(n in e){if(e[n].count==1){i=e[n].features;for(r=0;r<i.length;r++){if((""+i[r]).length>t){t=(""+i[r]).length}}}}if(this.settings.metadata){var e=this.metadata.nodes;for(n in e){i=e[n];for(r=0;r<i.length;r++){if((""+i[r]).length>t){t=(""+i[r]).length}}}}return t};InCHlib.prototype._preprocess_heatmap_data=function(){var e=[],t,n=0,r,i;for(t in this.data.nodes){i=this.data.nodes[t];if(i.count==1){r=i.features;e.push([t]);e[n].push.apply(e[n],r);if(this.settings.metadata){e[n].push.apply(e[n],this.metadata.nodes[t])}n++}}return e};InCHlib.prototype._reorder_heatmap=function(e){var t;this.leaves_y_coordinates={};if(this.ordered_by_index==e){this.heatmap_array.reverse()}else{if(this._is_number(this.heatmap_array[0][e])){this.heatmap_array.sort(function(t,n){return t[e]==null?-1:n[e]==null?1:t[e]-n[e]})}else{this.heatmap_array.sort(function(t,n){return t[e]==null?-1:n[e]==null?1:t[e]>n[e]?1:t[e]<n[e]?-1:0})}}var n=this.pixels_for_leaf;var r=n/2+this.header_height;for(t=0;t<this.heatmap_array.length;t++){this.leaves_y_coordinates[this.heatmap_array[t][0]]=r;r+=n}this.ordered_by_index=e;return};InCHlib.prototype.draw=function(e){if(e===undefined){this._add_prefix()}this.dimensions=this._get_dimensions(this.data.nodes);this.zoomed_clusters=[];this.heatmap_array=this._preprocess_heatmap_data();this.data_dimensions=this.dimensions;this.on_features=[];this.on_metadata_features=[];this.current_object_ids=[];if(this.settings.metadata){this.metadata_dimensions=this._get_dimensions(this.metadata.nodes);this.dimensions=this.data_dimensions+this.metadata_dimensions}else{this.metadata_dimensions=0}if(this.settings.heatmap){this._set_heatmap_settings()}else{this.dimensions=0}if(this.settings.column_dendrogram&&this.heatmap_header){this.footer_height=150}this.stage=new Kinetic.Stage({container:this.settings.target});this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height)/this.heatmap_array.length;if(this.pixels_for_leaf>this.settings.max_row_height){this.pixels_for_leaf=this.settings.max_row_height}if(this.settings.min_row_height>this.pixels_for_leaf){this.pixels_for_leaf=this.settings.min_row_height}this.settings.height=this.heatmap_array.length*this.pixels_for_leaf+this.header_height+this.footer_height;this.stage.setWidth(this.settings.width);this.stage.setHeight(this.settings.height);this._draw_stage_layer();this._draw_navigation();if(this.settings.dendrogram){this.root_id=this._get_root_id(this.data.nodes);this.distance=this.settings.width-this.heatmap_width-100;this._draw_row_dendrogram(this.root_id);this._draw_heatmap();if(this.settings.column_dendrogram){this.column_root_id=this._get_root_id(this.column_dendrogram.nodes);this._draw_column_dendrogram(this.column_root_id)}}else{this.settings.column_dendrogram=false;this.distance=this._hack_round((this.settings.width-this.heatmap_width)/2);this._reorder_heatmap(0);this.ordered_by_index=0;this._draw_heatmap()}this._draw_heatmap_header();this.navigation_layer.moveToTop();this.highlight_rows(this.settings.highlighted_rows)};InCHlib.prototype._draw_row_dendrogram=function(e){this.dendrogram_layer=new Kinetic.Layer;var t=this.data.nodes[e];var n=t.count;this.distance_step=this.distance/t.distance;this.last_highlighted_cluster=null;this.nodes_y_coordinates={};this.leaves_y_coordinates={};this.objects2leaves={};this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height)/n;if(this.pixels_for_leaf>this.settings.max_row_height){this.pixels_for_leaf=this.settings.max_row_height}if(this.settings.min_row_height>this.pixels_for_leaf){this.pixels_for_leaf=this.settings.min_row_height}this.settings.height=n*this.pixels_for_leaf+this.header_height+this.footer_height;this.stage.setWidth(this.settings.width);this.stage.setHeight(this.settings.height);var r=0;var i=0;var s=this.header_height+this.pixels_for_leaf/2;if(t.count>1){r=this.data.nodes[t.left_child].count;i=this.data.nodes[t.right_child].count}this._draw_row_dendrogram_node(e,t,r,i,0,s);this.middle_item_count=(this.min_item_count+this.max_item_count)/2;this._draw_distance_scale(t.distance);this.stage.add(this.dendrogram_layer);this.dendrogram_overlay_layer=new Kinetic.Layer;this.stage.add(this.dendrogram_overlay_layer);this.dendrogram_hover_layer=new Kinetic.Layer;this.stage.add(this.dendrogram_hover_layer);var o=this;this.dendrogram_layer.on("mouseover",function(e){o._dendrogram_layers_mouseover(e)});this.dendrogram_overlay_layer.on("mouseover",function(e){o._dendrogram_layers_mouseover(e)});this.dendrogram_layer.on("mouseout",function(e){o._dendrogram_layers_mouseout(e)});this.dendrogram_overlay_layer.on("mouseout",function(e){o._dendrogram_layers_mouseout(e)});this.dendrogram_layer.on("click",function(e){o._dendrogram_layers_click(e,this)});this.dendrogram_overlay_layer.on("click",function(e){o._dendrogram_layers_click(e,this)});this.dendrogram_layer.on("dblclick",function(e){if(e.targetNode.attrs.path_id!=o.root_id){o._zoom_cluster(e.targetNode.attrs.path_id)}})};InCHlib.prototype._draw_row_dendrogram_node=function(e,t,n,r,i,s){if(t.count!=1){this.nodes_y_coordinates[e]=s;var o=this._get_node_neighbourhood(t,this.data.nodes);var u=this.data.nodes[t.right_child];var a=this.data.nodes[t.left_child];var f=this._get_y1(o,n,r);var l=this._get_y2(o,n,r);var c=this._hack_round(this.distance-this.distance_step*t.distance);c=c==0?2:c;var h=c;var p=this.distance-this.distance_step*this.data.nodes[t.left_child].distance;var d=this.distance-this.distance_step*this.data.nodes[t.right_child].distance;if(u.count==1){l=l+this.pixels_for_leaf/2}this.dendrogram_layer.add(this._draw_horizontal_path(e,c,f,h,l,p,d));this._draw_row_dendrogram_node(t.left_child,a,n-o.left_node.right_count,r+o.left_node.right_count,p,f);this._draw_row_dendrogram_node(t.right_child,u,n+o.right_node.left_count,r-o.right_node.left_count,d,l)}else{var v;var m=t.objects;this.leaves_y_coordinates[e]=s;for(v=0;v<m.length;v++){this.objects2leaves[m[v]]=e}var g=t.objects.length;if(g<this.min_item_count){this.min_item_count=g}if(g>this.max_item_count){this.max_item_count=g}}};InCHlib.prototype._draw_stage_layer=function(){this.stage_layer=new Kinetic.Layer;var e=new Kinetic.Rect({x:0,y:0,width:this.settings.width,height:this.settings.height,opacity:0});this.stage_layer.add(e);e.moveToBottom();this.stage.add(this.stage_layer);var t=this;this.stage_layer.on("click",function(e){t.unhighlight_cluster();t.events.empty_space_onclick(e)})};InCHlib.prototype._draw_column_dendrogram=function(e){this.column_dendrogram_layer=new Kinetic.Layer;var t=this.column_dendrogram.nodes[e];this.vertical_distance=this.settings.header_as_heatmap_row?this.header_height-18:this.header_height-5;this.vertical_distance_step=this.vertical_distance/t.distance;var n=this.column_dendrogram.nodes[t.left_child].count;var r=this.column_dendrogram.nodes[t.right_child].count;this._draw_column_dendrogram_node(e,t,n,r,0,0);this.stage.add(this.column_dendrogram_layer)};InCHlib.prototype._delete_all_layers=function(){this.stage.destroyChildren()};InCHlib.prototype._set_heatmap_settings=function(){var e,t,n,r;this.header=[];for(e=0;e<this.dimensions;e++){this.header.push("")}this.heatmap_header=false;this.metadata_header=false;this.current_label=null;this.categories2numbers={};if(this.data.feature_names!==undefined){this.heatmap_header=this.data.feature_names;for(e=0;e<this.data_dimensions;e++){this.header[e]=this.heatmap_header[e]}if(this.heatmap_header.length>0&&this.settings.header_as_heatmap_row){var i=[];for(e=0;e<this.heatmap_header.length;e++){i.push([this.heatmap_header[e]])}this.header_min_max=this._get_columns_min_max_middle(i)[0];if(this.categories2numbers[0]){this.categories2numbers["header"]=this.categories2numbers[0]}var s=[];for(var e=0;e<this.heatmap_header.length;e++){s.push("")}this.data.nodes["header_row"]={features:s}}}else{this.settings.header_as_heatmap_row=false}var o=[];for(e in this.data.nodes){r=this.data.nodes[e];if(r.count==1){o.push(r.features)}}if(this.settings.independent_columns){this.columns_min_max=this._get_columns_min_max_middle(o)}else{var u=this._get_min_max_middle(o);this.max_value=u[1];this.min_value=u[0];this.middle_value=u[2]}if(this.settings.metadata){if(this.metadata.feature_names){this.metadata_header=this.metadata.feature_names;for(e=0;e<this.metadata_dimensions;e++){this.header[this.data_dimensions+e]=this.metadata_header[e]}}var a=[];for(e in this.metadata.nodes){a.push(this.metadata.nodes[e])}this.metadata_columns_min_max=this._get_columns_min_max_middle(a)}if(this.settings.count_column){this.max_item_count=1;this.min_item_count=1;this.dimensions++;this.header.push("Count")}if(!(this.heatmap_header||this.metadata_header)&&!this.settings.count_column){this.header=false}this.settings.heatmap_part_width=this.dimensions?this.settings.heatmap_part_width:0;this.settings.heatmap_part_width=this.settings.dendrogram?this.settings.heatmap_part_width:1;this.heatmap_width=this.dimensions?this._hack_round(this.settings.heatmap_part_width*(this.settings.width-100)):0;this.pixels_for_dimension=this.dimensions?this.heatmap_width/this.dimensions:0;if(this.settings.max_column_width&&this.settings.max_column_width<this.pixels_for_dimension){this.pixels_for_dimension=this.settings.max_column_width;this.heatmap_width=this.dimensions*this.pixels_for_dimension}this.features={};for(e=0;e<this.dimensions;e++){this.features[e]=1}};InCHlib.prototype._set_on_features=function(){this.on_features=[];this.on_metadata_features=[];for(var e in this.features){if(this.features[e]==1){if(e<this.data_dimensions){this.on_features.push(parseInt(e))}else{if(!this.settings.count_column||parseInt(e)<this.dimensions-1){this.on_metadata_features.push(parseInt(e)-this.data_dimensions)}}}}};InCHlib.prototype._draw_heatmap=function(){if(!this.settings.heatmap||this.dimensions==0){return}var e,t,n,r,i,s,o;this.heatmap_layer=new Kinetic.Layer;this.heatmap_overlay=new Kinetic.Layer;this.current_draw_values=true;this.max_value_length=this._get_max_value_length();this.value_font_size=this._get_font_size(this.max_value_length,this.pixels_for_dimension,this.pixels_for_leaf,12);if(this.value_font_size<4){this.current_draw_values=false}this._set_on_features();var u=this._hack_round(this.distance+this.dendrogram_heatmap_distance);var a=[];var f=this;for(e in this.leaves_y_coordinates){var l=this.leaves_y_coordinates[e];t=this._draw_heatmap_row(e,u,l);this.rows[e]=t;this.heatmap_layer.add(t);a.push([e,l]);this._bind_row_events(t)}if(this.settings.header_as_heatmap_row){t=this._draw_header_row(u);this.rows["header_row"]=t;this.heatmap_layer.add(t);this._bind_row_events(t)}if(this.settings.draw_row_ids){this._draw_row_ids(a)}this.stage.add(this.heatmap_layer);this.stage.add(this.heatmap_overlay);this.highlighted_rows_layer=new Kinetic.Layer;this.stage.add(this.highlighted_rows_layer);this.highlighted_rows_layer.moveToTop();this.row_borders=this.objects_ref.row_borders.clone();var f=this;this.heatmap_layer.on("mouseleave",function(e){f.heatmap_overlay.destroyChildren();f.heatmap_overlay.draw();f.events.heatmap_onmouseout(e)})};InCHlib.prototype._draw_heatmap_row=function(e,t,n){var r=this.data.nodes[e];var i=new Kinetic.Group({id:e});var s,o,u,a,f,l,c,h,p,d,v,m,g,y;for(c=0;c<this.on_features.length;c++){y=this.on_features[c];d=r.features[y];if(this.settings.independent_columns){this.min_value=this.columns_min_max[y][0];this.max_value=this.columns_min_max[y][1];this.middle_value=this.columns_min_max[y][2]}f=this._get_color_for_value(d,this.min_value,this.max_value,this.middle_value,this.settings.heatmap_colors);u=t+this.pixels_for_dimension;a=n;l=this.objects_ref.heatmap_line.clone({stroke:f,points:[t,n,u,a],value:d,column:["d",y].join("_"),strokeWidth:this.pixels_for_leaf});i.add(l);if(this.current_draw_values){v=this.objects_ref.heatmap_value.clone({x:this._hack_round((t+u)/2-(""+d).length*(this.value_font_size/4)),y:this._hack_round(n-this.value_font_size/2),fontSize:this.value_font_size,text:d});i.add(v)}t=u}if(this.settings.metadata){var b=this.metadata.nodes[e];for(c=0;c<this.on_metadata_features.length;c++){y=this.on_metadata_features[c];d=b[y];m=d;this.metadata_min_value=this.metadata_columns_min_max[y][0];this.metadata_max_value=this.metadata_columns_min_max[y][1];this.metadata_middle_value=this.metadata_columns_min_max[y][2];if(!this._is_number(m)){d=this.categories2numbers[y][d]}f=this._get_color_for_value(d,this.metadata_min_value,this.metadata_max_value,this.metadata_middle_value,this.settings.metadata_colors);u=t+this.pixels_for_dimension;a=n;l=this.objects_ref.heatmap_line.clone({stroke:f,points:[t,n,u,a],value:d,column:["m",y].join("_"),strokeWidth:this.pixels_for_leaf});i.add(l);if(this.current_draw_values){v=this.objects_ref.heatmap_value.clone({text:m,fontSize:this.value_font_size});g=v.getWidth();s=this._hack_round((t+u)/2-g/2);o=this._hack_round(n-this.value_font_size/2);v.position({x:s,y:o});i.add(v)}t=u}}if(this.settings.count_column&&this.features[this.dimensions-1]==1){u=t+this.pixels_for_dimension;var w=r.objects.length;f=this._get_color_for_value(w,this.min_item_count,this.max_item_count,this.middle_item_count,this.settings.count_column_colors);l=this.objects_ref.heatmap_line.clone({stroke:f,points:[t,n,u,a],value:w,column:"Count",strokeWidth:this.pixels_for_leaf});i.add(l);if(this.current_draw_values){v=this.objects_ref.heatmap_value.clone({text:w});g=v.getWidth();s=this._hack_round((t+u)/2-g/2);o=this._hack_round(n-this.value_font_size/2);v.position({x:s,y:o});i.add(v)}t=u}return i};InCHlib.prototype._bind_row_events=function(e){var t=this;e.on("mouseenter",function(e){t._row_mouseenter(e)});e.on("mouseleave",function(e){t._row_mouseleave(e)});e.on("mouseover",function(e){t._draw_col_label(e)});e.on("mouseout",function(e){t.heatmap_overlay.find("#col_label")[0].destroy()});e.on("click",function(e){var n=e.targetNode.parent.attrs.id;if(n!="header_row"){var r=t.data.nodes[n].objects;var s=[];for(i=0;i<r.length;i++){s.push(r[i])}t.events.row_onclick(s,e)}})};InCHlib.prototype._draw_row_ids=function(e){if(this.pixels_for_leaf<6){return}var t,n,r=[],i,s=[],o;for(t=0;t<e.length;t++){i=e[t];n=this.data.nodes[i[0]].objects;if(n.length>1){return}s.push(n[0]);r.push([n[0],i[1]])}var u=this._get_max_length(s);var a=this._get_font_size(u,85,this.pixels_for_leaf,12);var f=this.distance+(this.on_features.length+this.on_metadata_features.length)*this.pixels_for_dimension+15;f=this.settings.count_column?f+this.pixels_for_dimension:f;if(a>4){for(t=0;t<r.length;t++){o=this.objects_ref.heatmap_value.clone({x:f,y:this._hack_round(r[t][1]-a/2),fontSize:a,text:r[t][0],fontStyle:"italic",fill:"gray"});this.heatmap_layer.add(o)}}return};InCHlib.prototype._draw_header_row=function(e){var t=new Kinetic.Group({id:"header_row"});var n=14;var r=this.header_height-.5*n-2;var i,s,o,u,a,f,l,c,h,p,d,v;for(l=0;l<this.on_features.length;l++){v=this.on_features[l];c=this.heatmap_header[v];p=c;if(!this._is_number(p)){c=this.categories2numbers["header"][c]}a=this._get_color_for_value(c,this.header_min_max[0],this.header_min_max[1],this.header_min_max[2],this.settings.header_row_colors);o=e+this.pixels_for_dimension;u=r;f=this.objects_ref.heatmap_line.clone({strokeWidth:n,stroke:a,points:[e,r,o,u],column:["d",v].join("_")});t.add(f);e=o}return t};InCHlib.prototype._draw_heatmap_header=function(){this.header_layer=new Kinetic.Layer;var e=this._hack_size(this.leaves_y_coordinates);var t=this.settings.column_dendrogram&&this.heatmap_header?this.header_height+this.pixels_for_leaf*e+10:this.header_height-20;var n=this.settings.column_dendrogram&&this.heatmap_header?45:-45;t=n==-45&&this.settings.header_as_heatmap_row?t-10:t;var r=0;var i,s,o;var u=[];for(s=0;s<this.header.length;s++){u[s]=this.header[s]}var a=this._get_max_length(u);var f=this._hack_round(this.header_height*1.5/a);f=f>16?16:f;f=f>this.pixels_for_dimension?this.pixels_for_dimension-3:f;if(f<8){return}for(s=0;s<this.header.length;s++){if(this.features[s]==1||s>this.dimensions-1){i=this.distance+r*this.pixels_for_dimension+this.pixels_for_dimension/2;o=this.objects_ref.column_header.clone({x:i,y:t,text:this.header[s],position_index:s+1,fontSize:f,rotationDeg:n});this.header_layer.add(o);r++}}this.stage.add(this.header_layer);if(!this.settings.dendrogram){var l=this;this.header_layer.on("click",function(e){var t=e.targetNode;var n=t.attrs.order;var r=t.attrs.position_index;for(s=0;s<l.header_layer.getChildren().length;s++){l.header_layer.getChildren()[s].setFill("black")}e.targetNode.setAttrs({order:n,fill:"red"});l.heatmap_layer.destroyChildren();l.heatmap_layer.draw();l._reorder_heatmap(r,n);l._draw_heatmap()});this.header_layer.on("mouseover",function(e){var t=e.targetNode;t.setOpacity(.7);this.draw()});this.header_layer.on("mouseout",function(e){var t=e.targetNode;t.setOpacity(1);this.draw()})}};InCHlib.prototype._draw_distance_scale=function(e){this.distance_scale_layer=new Kinetic.Layer;var t=this.header_height-15;var n=t;var r=0;var i=this.distance;var s=new Kinetic.Line({points:[r,t,i,n],stroke:"black",listening:false});this.distance_scale_layer.add(s);var o=new Kinetic.Circle({x:i,y:n,radius:3,fill:"black",listening:false});this.distance_scale_layer.add(o);var u=0;var a=3;var f=i;var l=this._hack_round(30/this.distance_step*10)/10;var e=Math.round(100*this.distance/this.distance_step)/100;var c=this._hack_round(this.distance_step*l);var h=0;var p=new Kinetic.Text({x:0,y:t-20,text:e,fontSize:14,fontFamily:this.settings.font,fontStyle:"bold",fill:"black",align:"right",listening:false});this.distance_scale_layer.add(p);if(c==0){c=.5}var s;if(l>.1){while(f>0){s=new Kinetic.Line({points:[f,t-a,f,n+a],stroke:"black",listening:false});this.distance_scale_layer.add(s);u=this._hack_round((u+l)*10)/10;if(u>10){u=this._hack_round(u)}f=f-c;h++}}this.stage.add(this.distance_scale_layer)};InCHlib.prototype._draw_navigation=function(){this.navigation_layer=new Kinetic.Layer;var e=this;var t=[0,this._get_color_for_value(0,0,1,.5,this.settings.heatmap_colors),.5,this._get_color_for_value(.5,0,1,.5,this.settings.heatmap_colors),1,this._get_color_for_value(1,0,1,.5,this.settings.heatmap_colors)];var n=this.objects_ref.rect_gradient.clone({label:"Color settings",fillLinearGradientColorStops:t});n.on("mouseover",function(){e._color_scale_mouseover(n,e.navigation_layer)});n.on("mouseout",function(){e._color_scale_mouseout(n,e.navigation_layer)});n.on("click",function(){e._color_scale_click(n,e.navigation_layer)});this.navigation_layer.add(n);if(e.zoomed_clusters.length>0){var r=this.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",x:40,y:10,id:"refresh_icon",label:"Refresh"});e.navigation_layer.add(r);var i=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",x:80,y:10,label:"Zoom out"});var s=e._draw_icon_overlay(40,10);var o=e._draw_icon_overlay(80,10);e.navigation_layer.add(i);e.navigation_layer.add(s);e.navigation_layer.add(o);o.on("click",function(){e.events.on_unzoom(e._unprefix(e.zoomed_clusters[e.zoomed_clusters.length-1]));e._unzoom_icon_click(this)});o.on("mouseover",function(){e._icon_mouseover(i,o,e.navigation_layer)});o.on("mouseout",function(){e._icon_mouseout(i,o,e.navigation_layer)});s.on("click",function(){e._refresh_icon_click();e.events.on_refresh()});s.on("mouseover",function(){e._icon_mouseover(r,s,e.navigation_layer)});s.on("mouseout",function(){e._icon_mouseout(r,s,e.navigation_layer)})}if(e.header){var u=this.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:0,y:10,label:"Filter\ncolumns"});e.navigation_layer.add(u);var a=e._draw_icon_overlay(0,10);e.navigation_layer.add(a);a.on("click",function(){e._filter_icon_click(this)});a.on("mouseover",function(){e._icon_mouseover(u,a,e.navigation_layer)});a.on("mouseout",function(){e._icon_mouseout(u,a,e.navigation_layer)})}if(e.settings.show_export_button){var f=this.objects_ref.icon.clone({data:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z",x:e.settings.width-62,y:10,id:"export_icon",label:"Export\nin png format"});var l=e._draw_icon_overlay(e.settings.width-62,10);e.navigation_layer.add(f);e.navigation_layer.add(l);l.on("click",function(){e._export_icon_click(this)});l.on("mouseover",function(){e._icon_mouseover(f,l,e.navigation_layer)});l.on("mouseout",function(){e._icon_mouseout(f,l,e.navigation_layer)})}e.stage.add(e.navigation_layer)};InCHlib.prototype._draw_icon_overlay=function(e,t){var n=this.objects_ref.icon_overlay.clone({x:e,y:t});return n};InCHlib.prototype._highlight_path=function(e){var t=this.data.nodes[e];if(t.count!=1){var n=this._clone_path(this.dendrogram_layer.get("#"+e)[0]);if(n){n.setStroke("#F5273C");var r=this._clone_rect(this.dendrogram_layer.get("#"+e+"_rect")[0],n);r.setAttrs({path:n,path_id:e});this.dendrogram_overlay_layer.add(n);this.dendrogram_overlay_layer.add(r);this._highlight_path(t.left_child);this._highlight_path(t.right_child)}}else{if(this.settings.heatmap){var i=this.leaves_y_coordinates[e];this.row_y_coordinates.push(i)}}};InCHlib.prototype.unhighlight_rows=function(){this.highlight_rows([]);return};InCHlib.prototype.highlight_rows=function(e){var t,n,r;if(!this.settings.heatmap){return}this.settings.highlighted_rows=e;this.highlighted_rows_layer.destroyChildren();var i=this.settings.heatmap_colors;var s=this.settings.metadata_colors;this.settings.heatmap_colors=this.settings.highlight_colors;this.settings.metadata_colors=this.settings.highlight_colors;var o={};var u=[];for(t=0;t<e.length;t++){if(e[t]in this.objects2leaves){r=this.objects2leaves[e[t]];if(!(r in o)){u.push(r);o[r]=null}}}for(t=0;t<u.length;t++){n=this._draw_heatmap_row(u[t],this.distance+this.dendrogram_heatmap_distance,this.leaves_y_coordinates[u[t]]);this.highlighted_rows_layer.add(n);n.setAttr("listening",false)}this.highlighted_rows_layer.draw();this.heatmap_overlay.moveToTop();this.settings.heatmap_colors=i;this.settings.metadata_colors=s;var a=this;this.highlighted_rows_layer.on("click",function(e){a.heatmap_layer.fire("click")})};InCHlib.prototype._highlight_cluster=function(e){var t=[];if(this.last_highlighted_cluster){if(this.settings.heatmap){this.cluster_layer.removeChildren();this.cluster_layer.draw()}this.dendrogram_overlay_layer.removeChildren()}this.row_y_coordinates=[];this.last_highlighted_cluster=e;this._highlight_path(e);this.dendrogram_overlay_layer.draw();if(this.settings.heatmap){t=this._draw_cluster_layer(e)}this.events.dendrogram_node_highlight(t,e);return t};InCHlib.prototype.highlight_cluster=function(e){return this._highlight_cluster(this._prefix(e))};InCHlib.prototype.unhighlight_cluster=function(){if(this.last_highlighted_cluster){if(this.settings.heatmap){this.cluster_layer.removeChildren();this.cluster_layer.draw()}this.dendrogram_overlay_layer.removeChildren();this.dendrogram_overlay_layer.draw();this.events.dendrogram_node_unhighlight(this.last_highlighted_cluster);this.last_highlighted_cluster=null}return[]};InCHlib.prototype._neutralize_path=function(e){var t=this.data.nodes[e];if(t.count!=1){var n=this.dendrogram_layer.get("#"+e)[0];if(n){n.setStroke("grey");this._neutralize_path(t.right_child);this._neutralize_path(t.left_child)}}};InCHlib.prototype._draw_cluster_layer=function(){this.cluster_layer=new Kinetic.Layer;var e=this.on_features.length+this.on_metadata_features.length;if(this.settings.count_column){e++}var t=this.data.nodes[this.last_highlighted_cluster].count;var n=this.distance+e*this.pixels_for_dimension+100;var r=this._hack_round(this.distance+e*this.pixels_for_dimension+20);if(this.settings.heatmap){var i=this._hack_round(this.row_y_coordinates[0]-this.pixels_for_leaf/2);var s=this._hack_round(this.row_y_coordinates[this.row_y_coordinates.length-1]+.5*this.pixels_for_leaf)}else{var o=this._hack_round(this.nodes_y_coordinates[this.last_highlighted_cluster]-this.pixels_for_leaf/2-20)}var u=this.objects_ref.row_count.clone({x:r,y:i-20,text:t+" rows"});this.cluster_layer.add(u);var a=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",x:r-5,y:s+8,label:"Zoom in"});var f=this.objects_ref.cluster_border.clone({points:[0,i,n,i]});this.cluster_layer.add(f);f=this.objects_ref.cluster_border.clone({points:[0,s,n,s]});this.cluster_layer.add(f);var l=this._collect_object_ids(i,s);var c=this.distance+this.dendrogram_heatmap_distance;var h=this.header_height;var n=e*this.pixels_for_dimension+100;var p=this.settings.height-this.header_height;var d=this.row_y_coordinates[0]-this.pixels_for_leaf/2;var v=this.row_y_coordinates[this.row_y_coordinates.length-1]+this.pixels_for_leaf/2;var m=this.objects_ref.cluster_overlay.clone({x:c,y:h,width:n,height:d-h-1});this.cluster_layer.add(m);m=this.objects_ref.cluster_overlay.clone({x:c,y:v+1,width:n,height:this.settings.height-v-this.footer_height});this.cluster_layer.add(m);var g=this._draw_icon_overlay(r-5,s);this.cluster_layer.add(a);this.cluster_layer.add(g);this.stage.add(this.cluster_layer);u.moveToTop();this.cluster_layer.draw();var y=this;g.on("mouseover",function(){y._icon_mouseover(a,g,y.cluster_layer)});g.on("mouseout",function(){y._icon_mouseout(a,g,y.cluster_layer)});g.on("click",function(){y._zoom_cluster(y.last_highlighted_cluster)});this.cluster_layer.on("click",function(e){y.unhighlight_cluster();y.events.empty_space_onclick(e)});return l};InCHlib.prototype._zoom_cluster=function(e){if(e!=this.zoomed_clusters[this.zoomed_clusters.length-1]&&e!=this.root_id){this.current_object_ids=[];this._get_object_ids(e);this.events.on_zoom(this.current_object_ids,this._unprefix(e));this.zoomed_clusters.push(e);this._delete_all_layers();this._draw_stage_layer();this._draw_row_dendrogram(e);if(this.settings.column_dendrogram&&this._visible_features_equal_column_dendrogram_count()){this._draw_column_dendrogram(this.column_root_id)}this._draw_navigation();this._draw_heatmap();this._draw_heatmap_header();this.highlight_rows(this.settings.highlighted_rows)}else{return false}};InCHlib.prototype._get_node_neighbourhood=function(e,t){var n=this;var r={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},left_count:t[e.left_child].count,right_count:t[e.right_child].count};var i=t[e.left_child];var s=t[e.right_child];var o=t[i.left_child];var u=t[i.right_child];var a=t[s.left_child];var f=t[s.right_child];if(i.count!=1){r.left_node.left_count=t[i.left_child].count;r.left_node.right_count=t[i.right_child].count;if(o.count!=1){r.left_node.left_node.left_count=t[o.left_child].count;r.left_node.left_node.right_count=t[o.right_child].count}else{r.left_node.left_node.left_count=.5;r.left_node.left_node.right_count=.5}if(u.count!=1){r.left_node.right_node.left_count=t[u.left_child].count;r.left_node.right_node.right_count=t[u.right_child].count}else{r.left_node.right_node.left_count=.5;r.left_node.right_node.right_count=.5}}if(s.count!=1){r.right_node.left_count=t[s.left_child].count;r.right_node.right_count=t[s.right_child].count;if(a.count!=1){r.right_node.left_node.left_count=t[a.left_child].count;r.right_node.left_node.right_count=t[a.right_child].count}else{r.right_node.left_node.left_count=.5;r.right_node.left_node.right_count=.5}if(f.count!=1){r.right_node.right_node.left_count=t[f.left_child].count;r.right_node.right_node.right_count=t[f.right_child].count}else{r.right_node.right_node.left_count=.5;r.right_node.right_node.right_count=.5}}return r};InCHlib.prototype._draw_column_dendrogram_node=function(e,t,n,r,i,s){if(t.count!=1){var o=this._get_node_neighbourhood(t,this.column_dendrogram.nodes);var u=this.column_dendrogram.nodes[t.right_child];var a=this.column_dendrogram.nodes[t.left_child];var f=this._get_x1(o,n,r);var l=this._get_x2(o,n,r);var c=this._hack_round(this.vertical_distance-this.vertical_distance_step*t.distance);c=c==0?2:c;var h=c;if(u.count==1){l=l-this.pixels_for_dimension/2}var p=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[t.left_child].distance;var d=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[t.right_child].distance;this.column_dendrogram_layer.add(this._draw_vertical_path(e,f,c,l,h,p,d));this._draw_column_dendrogram_node(t.left_child,a,n-o.left_node.right_count,r+o.left_node.right_count,p,c);this._draw_column_dendrogram_node(t.right_child,u,n+o.right_node.left_count,r-o.right_node.left_count,d,h)}};InCHlib.prototype._get_y1=function(e,t,n){t=t-e.left_node.right_count-e.left_node.left_node.right_count;var r=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*this.pixels_for_leaf;return r+this.header_height};InCHlib.prototype._get_y2=function(e,t,n){t=t+e.right_node.left_node.left_count;var r=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*this.pixels_for_leaf;return r+this.header_height};InCHlib.prototype._get_x1=function(e,t,n){var r=this.column_dendrogram.nodes[this.column_root_id].count;t=t-e.left_node.right_count-e.left_node.left_node.right_count;var i=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*this.pixels_for_dimension;return this.distance+this.dendrogram_heatmap_distance+r*this.pixels_for_dimension-i};InCHlib.prototype._get_x2=function(e,t,n){var r=this.column_dendrogram.nodes[this.column_root_id].count;t=t+e.right_node.left_node.left_count;var i=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*this.pixels_for_dimension;return this.distance+this.dendrogram_heatmap_distance+r*this.pixels_for_dimension-i};InCHlib.prototype._draw_vertical_path=function(e,t,n,r,i,s,o){var u=this.objects_ref.column_node.clone({points:[t,s,t,n,r,i,r,o]});return u};InCHlib.prototype._draw_horizontal_path=function(e,t,n,r,i,s,o){var u=new Kinetic.Group({});var a=this.objects_ref.row_node.clone({points:[s,n,t,n,r,i,o,i],id:e});var f=this.objects_ref.row_node_rect.clone({x:t-1,y:n-1,width:this.distance-t,height:i-n,id:[e,"rect"].join("_"),path:a,path_id:e});u.add(a);u.add(f);return u};InCHlib.prototype._filter_icon_click=function(t){var n=this;var r=this.target_element.find(".filter_features");var i="✖";if(r.length){r.fadeIn("fast");var s=n._draw_target_overlay()}else{filter_list="";for(var o in n.header){if(n.features[o]==1){i="✔"}if(o<n.dimensions){var u=n.header[o];if(u==""){u=parseInt(o)+1+". column"}filter_list=filter_list+"<li class='feature_switch' data-num='"+o+"'><span class='symbol'>"+i+"</span>  "+u+"</li>"}}e("#"+n.settings.target).append("<div class='filter_features'><ul>"+filter_list+"</ul><hr /><div><span class='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span class='update_filter_list'>Update</span></div></div>");r=e("#"+n.settings.target).find(".filter_features");r.css({display:"none",top:45,left:0,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 2px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","font-size":"14px","z-index":1e3,"font-family":n.settings.font});r.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"});r.find("li").css({color:"green","margin-top":"5px"});r.find("div").css({cursor:"pointer",opacity:"0.7"});var s=n._draw_target_overlay();r.fadeIn("fast");e("#"+n.settings.target+" .feature_switch").click(function(){var t=parseInt(e(this).attr("data-num"));var r=e(this).find("span");n.features[t]=-n.features[t];if(n.features[t]==1){r.text("✔");e(this).css("color","green")}else{r.text("✖");e(this).css("color","red")}n._set_on_features()});e(function(){r.click(function(){return false});r.mousedown(function(){return false});e("#"+n.settings.target+" .filter_features ul li,"+"#"+n.settings.target+" .filter_features div span").hover(function(){e(this).css({cursor:"pointer",opacity:"0.7"})},function(){e(this).css({cursor:"default",opacity:"1"})})});e("#"+n.settings.target+" .cancel_filter_list").click(function(){r.fadeOut("fast");s.fadeOut("fast")});s.click(function(){r.fadeOut("fast");s.fadeOut("fast")});e("#"+n.settings.target+" .update_filter_list").click(function(){r.fadeOut("fast");s.fadeOut("fast");var e=n.zoomed_clusters.length>0?n.zoomed_clusters[n.zoomed_clusters.length-1]:n.root_id;var t=n.last_highlighted_cluster;n.last_highlighted_cluster=null;n.distance=n._hack_round((n.settings.width-100)*(1-n.settings.heatmap_part_width));n.heatmap_width=n.settings.width-n.distance-100;var i=n.on_features.length+n.on_metadata_features.length;if(n.settings.count_column&&n.features[n.features.length-1]===1){i++}n.pixels_for_dimension=n.heatmap_width/i;n.pixels_for_dimension=n.pixels_for_dimension>n.settings.max_column_width?n.settings.max_column_width:n.pixels_for_dimension;var o=n.distance+n.heatmap_width;n.heatmap_width=i*n.pixels_for_dimension;n.distance=n.settings.dendrogram?o-i*n.pixels_for_dimension:n._hack_round((n.settings.width-n.heatmap_width)/2);n._delete_all_layers();n._draw_stage_layer();if(n.settings.dendrogram){n._draw_row_dendrogram(e)}if(n._visible_features_equal_column_dendrogram_count()&&n.settings.column_dendrogram){n._draw_column_dendrogram(n.column_root_id)}n._draw_navigation();n._draw_heatmap();n._draw_heatmap_header();if(t!=null){n._highlight_cluster(t)}})}};InCHlib.prototype._draw_target_overlay=function(){var t=this.target_element.find(".target_overlay");if(t.length){t.fadeIn("fast")}else{t=e("<div class='target_overlay'></div>");t.css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5});this.target_element.append(t)}return t};InCHlib.prototype._refresh_icon_click=function(){var e=this.root_id;this.zoomed_clusters=[];this._delete_all_layers();this._draw_stage_layer();this._draw_row_dendrogram(e);if(this.settings.column_dendrogram&&this._visible_features_equal_column_dendrogram_count()){this._draw_column_dendrogram(this.column_root_id)}this._draw_navigation();this._draw_heatmap();this._draw_heatmap_header();this.highlight_rows(this.settings.highlighted_rows)};InCHlib.prototype._unzoom_icon_click=function(){var e=this.zoomed_clusters[this.zoomed_clusters.length-1];this.zoomed_clusters.pop();if(this.zoomed_clusters.length>=1){var t=this.zoomed_clusters[this.zoomed_clusters.length-1];this.zoomed_clusters.pop();this._zoom_cluster(t)}else{this._refresh_icon_click()}this._highlight_cluster(e)};InCHlib.prototype._icon_mouseover=function(e,t,n){var r=e.getAttr("label");var i=t.getAttr("x");var s=t.getAttr("y");var o=t.getWidth();var u=t.getHeight();if(e.getAttr("id")==="export_icon"){i=i-50}this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:i,y:s+1.2*u});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:r}));n.add(this.icon_tooltip);e.setFill("black");n.draw()};InCHlib.prototype._icon_mouseout=function(e,t,n){this.icon_tooltip.destroy();e.setFill("grey");n.draw()};InCHlib.prototype._color_scale_click=function(t,n){var r=this;var i,s,o,u;var a={heatmap_colors:"Heatmap data colors",metadata_colors:"Heatmap metadata colors"};if(this.settings.header_as_heatmap_row){a["header_row_colors"]="Header row colors"}var f="settings_form_"+this.settings.target;var l=e("#"+f);var c=this._draw_target_overlay();if(l.length){l.fadeIn("fast")}else{l=e("<form class='settings_form' id='"+f+"'></form>");var h="",p,d,v;for(i=0,keys=Object.keys(a),len=keys.length;i<len;i++){o=keys[i];p=this._get_color_for_value(0,0,1,.5,this.settings[o]);d=this._get_color_for_value(.5,0,1,.5,this.settings[o]);v=this._get_color_for_value(1,0,1,.5,this.settings[o]);s="<div><div class='form_label'>"+a[o]+"</div><input type='text' name='"+o+"' value='"+this.settings[o]+"'/> <div class='color_button' style='background: linear-gradient(to right, "+p+","+d+","+v+")'></div></div>";h=h+s}h=h+'<button type="submit">Redraw</button>';l.html(h);this.target_element.append(l);l.css({"z-index":1e3,position:"absolute",top:110,left:0,padding:"10px",border:"solid #D2D2D2 2px","border-radius":"5px","background-color":"white"});e("#"+f+" .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"});e("#"+f+" > div").css({"font-size":"12px","margin-bottom":"10px"});e("#"+f+" input").css({"border-radius":"5px",width:"100px"});e("#"+f+" .form_label").css({color:"gray","margin-bottom":"5px","font-style":"italic"});e("#"+f+" button").css({"padding-top":"7px","padding-bottom":"5px","padding-right":"5px","padding-left":"5px",color:"white",border:"solid #D2D2D2 1px","border-radius":"5px",width:"100%","background-color":"#2171b5","font-weight":"bold"})}c.click(function(){l.fadeOut("fast");c.fadeOut("fast")});var m=e("#"+f+" .color_button");m.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});m.click(function(e){r._draw_color_scales_select(this,e)});l.submit(function(t){var n={};var i=e(this).find("input");i.each(function(){s=e(this);o=s.attr("name");u=s.val();if(u!=""){if(u=="on"){u=true}n[o]=u}});r.update_settings(n);r.redraw();t.preventDefault();t.stopPropagation()})};InCHlib.prototype._draw_color_scales_select=function(t,n){var r=this.target_element.find(".color_scales");var i;var s=this;if(r.length){r.fadeIn("fast");i=r.find(".color_scale")}else{r=e("<div class='color_scales'></div>");var o,u,a,f,l;for(var c=0,h=Object.keys(this.colors),p=h.length;c<p;c++){l=h[c];u=this._get_color_for_value(0,0,1,.5,l);a=this._get_color_for_value(.5,0,1,.5,l);f=this._get_color_for_value(1,0,1,.5,l);o="<div class='color_scale' data-scale_acronym='"+l+"' style='background: linear-gradient(to right, "+u+","+a+","+f+")'></div>";r.append(o)}this.target_element.append(r);r.css({border:"solid #D2D2D2 2px","border-radius":"5px",padding:"5px",position:"absolute",top:110,left:170,"background-color":"white"});i=this.target_element.find(".color_scale");i.css({"margin-top":"3px",width:"80px",height:"20px",border:"solid #D2D2D2 1px"});i.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});this.target_element.find(".target_overlay").click(function(){r.fadeOut("fast")})}i.on("click",function(){var n=e(this).attr("data-scale_acronym");var o=e(t).prev("input:first").val(n);e(t).css({background:"linear-gradient(to right, "+s._get_color_for_value(0,0,1,.5,n)+","+s._get_color_for_value(.5,0,1,.5,n)+","+s._get_color_for_value(1,0,1,.5,n)+")"});r.fadeOut("fast");i.off("click")})};InCHlib.prototype._color_scale_mouseover=function(e,t){var n=e.getAttr("label");var r=e.getAttr("x");var i=e.getAttr("y");this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:r,y:i+25});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:n}));t.add(this.icon_tooltip);this.icon_tooltip.moveToTop();e.setOpacity(.7);t.draw()};InCHlib.prototype._color_scale_mouseout=function(e,t){this.icon_tooltip.destroy();e.setOpacity(1);t.draw()};InCHlib.prototype._dendrogram_layers_click=function(e,t){var n=[];var r=e.targetNode.attrs.path_id;t.fire("mouseout",e);if(r!=this.last_highlighted_cluster){n=this._highlight_cluster(r)}else{this.unhighlight_cluster()}t.draw();this.events.dendrogram_node_onclick(n,r,e)};InCHlib.prototype._dendrogram_layers_mouseout=function(e){var t=e.targetNode.className;if(t=="Rect"){var n=this.dendrogram_hover_layer.get("#"+[this.settings.target,"path_hover"].join("_"))[0];if(n){this.dendrogram_hover_layer.get("#"+[this.settings.target,"path_hover"].join("_"))[0].destroy();this.dendrogram_hover_layer.draw()}}};InCHlib.prototype._dendrogram_layers_mouseover=function(e){var t=e.targetNode.className;if(t=="Rect"){var n=e.targetNode.attrs.path;var r=this._clone_path(n);r.setStrokeWidth(4);r.setId([this.settings.target,"path_hover"].join("_"));this.dendrogram_hover_layer.add(r);this.dendrogram_hover_layer.draw()}};InCHlib.prototype._visible_features_equal_column_dendrogram_count=function(){var e;if(this.on_features.length===this.data_dimensions){return true}return false};InCHlib.prototype._clone_path=function(e){var t=new Kinetic.Line({points:e.attrs.points,stroke:e.attrs.stroke,strokeWidth:e.attrs.strokeWidth,lineCap:e.attrs.lineCap,lineJoin:e.attrs.lineJoin,listening:e.attrs.listening});return t};InCHlib.prototype._clone_rect=function(e){var t=new Kinetic.Rect({x:e.attrs.x,y:e.attrs.y,width:e.attrs.width,height:e.attrs.height,opacity:e.attrs.opacity,listening:e.attrs.listening});return t};InCHlib.prototype._get_color_for_value=function(e,t,n,r,i){var s=this.colors[i];var o=s["start"];var u=s["end"];if(t==n){return"rgb("+o.r+","+o.g+","+o.b+")"}if("middle"in s){if(e>=r){t=r;o=s["middle"];u=s["end"]}else{n=r;o=s["start"];u=s["middle"]}}var a=(e-t)/(n-t);var f=this._hack_round(o.r+a*(u.r-o.r));var l=this._hack_round(o.g+a*(u.g-o.g));var c=this._hack_round(o.b+a*(u.b-o.b));var h="rgb("+f+","+l+","+c+")";return h};InCHlib.prototype._get_font_size=function(e,t,n,r){var i=n-2;var s=i;if(s/2*e>t-10){s=s/(s/2*e/(t-10))}s=s>i?i:s;s=s>r?r:s;return s};InCHlib.prototype._export_icon_click=function(){function s(t){e('<a download="inchlib" href="'+t+'"></a>')[0].click()}function o(e){window.open(e,"_blank")}var t=this;var n=this.target_element.find(".export_menu");var r=this._draw_target_overlay();if(n.length){n.fadeIn("fast")}else{n=e("<div class='export_menu'><div><button type='submit' data-action='open'>Show image</button></div><div><button type='submit' data-action='save'>Save image</button></div></div>");this.target_element.append(n);n.css({position:"absolute",top:45,left:t.settings.width-125,"font-size":"12px",border:"solid #D2D2D2 1px","border-radius":"5px",padding:"2px","background-color":"white"});var i=n.find("button");i.css({"padding-top":"7px","padding-bottom":"5px","padding-right":"8px","padding-left":"8px",color:"white",border:"solid #D2D2D2 1px",width:"100%","background-color":"#2171b5","font-weight":"bold"});i.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});r.click(function(){n.fadeOut("fast");r.fadeOut("fast")});i.click(function(){var n=e(this).attr("data-action");var i=3;var u=t.stage.width();var a=t.stage.height();var f=e("<h3 style='margin-top: 100px; margin-left: 100px; width: "+u+"px; height: "+a+"px;'>Loading...</h3>");t.target_element.after(f);t.target_element.hide();t.stage.width(u*i);t.stage.height(a*i);t.stage.scale({x:i,y:i});t.stage.draw();t.navigation_layer.hide();t.stage.toDataURL({quality:1,callback:function(e){if(n==="open"){o(e)}else{s(e)}t.stage.width(u);t.stage.height(a);t.stage.scale({x:1,y:1});t.stage.draw();f.remove();t.target_element.show();t.navigation_layer.show();t.navigation_layer.draw();r.trigger("click")}})})}};InCHlib.prototype._collect_object_ids=function(e,t){var n=[];var r=[];var i,s,o;for(s in this.leaves_y_coordinates){if(this.leaves_y_coordinates[s]>e&&this.leaves_y_coordinates[s]<t){n.push(s)}}for(s=0;s<n.length;s++){i=this.data.nodes[n[s]];for(o=0;o<i.objects.length;o++){r.push(i.objects[o])}}return r};InCHlib.prototype._hack_size=function(e){var t=0,n;for(n in e){if(e.hasOwnProperty(n)){t++}}return t};InCHlib.prototype._hack_round=function(e){return.5+e>>0};InCHlib.prototype._middle2fnc=function(e){var t=this;var n={zero:function(e){return 0},median:function(e){e.sort(function(e,t){return e-t});var n=t._hack_round(e.length/2);return e[n]},mean:function(e){var t=e.reduce(function(e,t){return parseFloat(e)+t});return t/e.length}};return n[this.settings.values_center](e)};InCHlib.prototype._is_number=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};InCHlib.prototype._row_mouseenter=function(e){var t=e.targetNode.parent.getAttr("id");var n=this.on_features.length+this.on_metadata_features.length;if(this.settings.count_column){n++}if(t!="header_row"){this.highlighted_row=t;var r=this.leaves_y_coordinates[t]-.5*this.pixels_for_leaf;var i=this.distance+this.dendrogram_heatmap_distance;this.row_borders=this.objects_ref.row_borders.clone();var s=this.objects_ref.row_border.clone({points:[i,r,i+n*this.pixels_for_dimension,r]});this.row_borders.add(s);r=r+this.pixels_for_leaf;this.row_borders.add(this.objects_ref.row_border.clone({points:[i,r,i+n*this.pixels_for_dimension,r]}));this.heatmap_overlay.add(this.row_borders);this.heatmap_overlay.draw();this.events.row_onmouseover(this.data.nodes[t].objects,e)}};InCHlib.prototype._row_mouseleave=function(e){this.row_borders.destroy();this.events.row_onmouseout(e)};InCHlib.prototype._draw_col_label=function(e){var t,n;var r=e.targetNode.attrs;var i=r.points;var s=this._hack_round((i[0]+i[2])/2);var o=i[1]-.5*this.pixels_for_leaf;var u=r.column.split("_");var a={d:this.heatmap_header[u[1]],m:this.metadata_header[u[1]],Count:"Count"};var f=r.value;var l=a[u[0]];if(f||f===0){f=[l,f].join("\n")}else{f=l}var c=this.objects_ref.tooltip_label.clone({x:s,y:o,id:"col_label"});c.add(this.objects_ref.tooltip_tag.clone({pointerDirection:"down"}));c.add(this.objects_ref.tooltip_text.clone({text:f}));this.heatmap_overlay.add(c);this.heatmap_overlay.moveToTop();this.heatmap_overlay.draw();return};InCHlib.prototype._unprefix=function(e){return e.split(this.settings.target+"#")[1]};InCHlib.prototype._prefix=function(e){return this.settings.target+"#"+e};InCHlib.prototype.update_settings=function(t){e.extend(this.settings,t);return};InCHlib.prototype.redraw=function(){var e=false;this._delete_all_layers();this.draw(e);return};InCHlib.prototype._get_object_ids=function(e){if(this.data.nodes[e]["left_child"]!==undefined){this._get_object_ids(this.data.nodes[e]["left_child"]);this._get_object_ids(this.data.nodes[e]["right_child"])}else{this.current_object_ids.push.apply(this.current_object_ids,this.data.nodes[e]["objects"])}}})(jQuery)